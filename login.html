<!DOCTYPE html>
<html>
<head>
  <title>Login - Bhavesh Plastic Industries</title>
  <link rel="stylesheet" href="style.php">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="Bhavesh Plastic Industries.png" type="image/x-icon">
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div class="login-box">
    <div class="login-header">
      <img src="Bhavesh Plastic Industries.png" alt="Logo">
      <h2 style="color: #fff; font-size: 1.8rem; margin: 0;">Login</h2>
    </div>

    <input type="text" id="username" placeholder="Username">

    <!-- Password with eye emoji -->
    <div class="password-row">
      <input type="password" id="password" placeholder="Password">
      <span class="pass-toggle-btn" onclick="togglePassword('password', this)">üëÅÔ∏è</span>
    </div>

    <button onclick="login()">Login</button>

    <div class="change-password-button">
      <button onclick="toggleChangePassword()">Change Password</button>
    </div>
    
    <div class="change-password-box" id="changeBox" style="display:none;">
      <div class="password-row">
        <input type="password" id="oldPassword" placeholder="Old Password">
        <button type="button" class="pass-toggle-btn" onclick="togglePassword('oldPassword', this)">üëÅÔ∏è</button>
      </div>

      <div class="password-row">
        <input type="password" id="newPassword" placeholder="New Password">
        <button type="button" class="pass-toggle-btn" onclick="togglePassword('newPassword', this)">üëÅÔ∏è</button>
      </div>

      <div class="password-row">
        <input type="password" id="confirmPassword" placeholder="Confirm New Password">
        <button type="button" class="pass-toggle-btn" onclick="togglePassword('confirmPassword', this)">üëÅÔ∏è</button>
      </div>

      <button onclick="changePassword()">Submit</button>
    </div>

    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>
  </div>

  <script>
    function login() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = '';

      fetch("login.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username: user, password: pass })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          localStorage.setItem('loggedIn', 'true');
          localStorage.setItem('username', data.username);
          localStorage.setItem('user_id', data.user_id);
          localStorage.setItem('role', data.role);
          window.location.href = 'index.html';
        } else {
          errorMsg.textContent = 'Invalid username or password.';
        }
      })
      .catch(err => {
        errorMsg.textContent = 'An error occurred. Please try again later.';
        console.error("Login error:", err);
      });
    }

    function toggleChangePassword() {
      const box = document.getElementById('changeBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    function changePassword() {
      const user = document.getElementById('username').value.trim();
      const oldPass = document.getElementById('oldPassword').value.trim();
      const newPass = document.getElementById('newPassword').value.trim();
      const confirmPass = document.getElementById('confirmPassword').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      if (user !== 'ADMIN1' && user !== 'ADMIN2') {
        errorMsg.textContent = 'Enter a valid admin username.';
        return;
      }

      if (newPass !== confirmPass) {
        errorMsg.textContent = 'New passwords do not match.';
        return;
      }

      if (newPass.length < 6) {
        errorMsg.textContent = 'New password must be at least 6 characters.';
        return;
      }

      fetch("change_password.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          username: user,
          old_password: oldPass,
          new_password: newPass
        })
      })
      .then(res => res.text())
      .then(data => {
        if (data.includes("success")) {
          successMsg.textContent = 'Password changed successfully.';
        } else {
          errorMsg.textContent = data;
        }
      })
      .catch(err => {
        errorMsg.textContent = "Error changing password.";
        console.error("Change password error:", err);
      });
    }

    function togglePassword(id, el) {
      const passwordField = document.getElementById(id);
      if (passwordField.type === "password") {
        passwordField.type = "text";
      } else {
        passwordField.type = "password";
      }
    }

  </script>
</body>
</html>
