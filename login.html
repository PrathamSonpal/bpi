<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - Bhavesh Plastic Industries</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="Bhavesh Plastic Industries.png" type="image/x-icon">
  <link rel="manifest" href="manifest.json">

  <script>
    // ‚úÖ Redirect if already logged in
    if (sessionStorage.getItem('loggedIn') === 'true') {
      window.location.href = 'index.html';
    }

    // ‚úÖ Backend API base (InfinityFree server)
    const API_BASE = "https://bpi.infinityfreeapp.com/";
  </script>
</head>
<body>
  <div class="login-box">
    <div class="login-header">
      <img src="Bhavesh Plastic Industries.png" alt="Logo">
      <h2 style="color: #fff; font-size: 1.8rem; margin: 0;">Login</h2>
    </div>

    <!-- Username -->
    <input type="text" id="username" placeholder="Username">

    <!-- Password with toggle -->
    <div class="password-row">
      <input type="password" id="password" placeholder="Password">
      <span class="pass-toggle-btn" onclick="togglePassword('password', this)">üëÅÔ∏è</span>
    </div>

    <!-- Login Button -->
    <button onclick="login()">Login</button>

    <!-- Change Password Section -->
    <div class="change-password-button">
      <button onclick="toggleChangePassword()">Change Password</button>
    </div>
    
    <div class="change-password-box" id="changeBox" style="display:none;">
      <div class="password-row">
        <input type="password" id="oldPassword" placeholder="Old Password">
        <span class="pass-toggle-btn" onclick="togglePassword('oldPassword', this)">üëÅÔ∏è</span>
      </div>

      <div class="password-row">
        <input type="password" id="newPassword" placeholder="New Password">
        <span class="pass-toggle-btn" onclick="togglePassword('newPassword', this)">üëÅÔ∏è</span>
      </div>

      <div class="password-row">
        <input type="password" id="confirmPassword" placeholder="Confirm New Password">
        <span class="pass-toggle-btn" onclick="togglePassword('confirmPassword', this)">üëÅÔ∏è</span>
      </div>

      <button onclick="changePassword()">Submit</button>
    </div>

    <!-- Messages -->
    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>
  </div>

  <script>
    // ‚úÖ Login Function
    function login() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = '';

      if (!user || !pass) {
        errorMsg.textContent = "Please enter username and password.";
        return;
      }

      fetch(API_BASE + "login.php", {
        method: "POST",
        mode: "cors", // ‚úÖ Ensure CORS
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username: user, password: pass })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          sessionStorage.setItem('loggedIn', 'true');
          sessionStorage.setItem('username', data.username);
          sessionStorage.setItem('user_id', data.user_id);
          sessionStorage.setItem('role', data.role);
          window.location.href = 'index.html';
        } else {
          errorMsg.textContent = data.error || 'Invalid username or password.';
        }
      })
      .catch(err => {
        errorMsg.textContent = '‚ö†Ô∏è An error occurred. Please try again later.';
        console.error("Login error:", err);
      });
    }

    // ‚úÖ Toggle Change Password Box
    function toggleChangePassword() {
      const box = document.getElementById('changeBox');
      box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    }

    // ‚úÖ Change Password Function
    function changePassword() {
      const user = document.getElementById('username').value.trim();
      const oldPass = document.getElementById('oldPassword').value.trim();
      const newPass = document.getElementById('newPassword').value.trim();
      const confirmPass = document.getElementById('confirmPassword').value.trim();
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      if (!user || !oldPass || !newPass || !confirmPass) {
        errorMsg.textContent = 'All fields are required.';
        return;
      }

      if (newPass !== confirmPass) {
        errorMsg.textContent = 'New passwords do not match.';
        return;
      }

      if (newPass.length < 6) {
        errorMsg.textContent = 'New password must be at least 6 characters.';
        return;
      }

      fetch(API_BASE + "change_password.php", {
        method: "POST",
        mode: "cors", // ‚úÖ Ensure CORS
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          username: user,
          old_password: oldPass,
          new_password: newPass
        })
      })
      .then(res => res.text())
      .then(data => {
        if (data.includes("success")) {
          successMsg.textContent = '‚úÖ Password changed successfully.';
        } else {
          errorMsg.textContent = data;
        }
      })
      .catch(err => {
        errorMsg.textContent = "‚ö†Ô∏è Error changing password.";
        console.error("Change password error:", err);
      });
    }

    // ‚úÖ Toggle Password Visibility
    function togglePassword(id) {
      const field = document.getElementById(id);
      field.type = (field.type === "password") ? "text" : "password";
    }
  </script>
</body>
</html>
