<!DOCTYPE html>
<html>
  <head>
    <title>Bhavesh Plastic Industries</title>
    <link rel="icon" href="Bhavesh Plastic Industries.png" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.php">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      // Redirect to login if not logged in
      if (sessionStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
      }
    </script>
  </head>

  <body>
    <div class="container">
      <div class="header-container">
        <div class="logo-section">
          <img src="Bhavesh Plastic Industries.png" alt="Logo">
          <h1>Stock & Sales Log</h1>
        </div>
        <div class="nav-buttons">
          <a href="register-item.html" class="btn-secondary">Register New Item</a>
          <button onclick="logout()" class="btn-danger">Logout</button>
        </div>
      </div>

      <div id="lowStockContainer" class="low-stock-container">
        <div class="low-stock-header">
          <h4>⚠️ Low Stock Alert</h4>
          <button id="closeLowStock" class="close-btn">&times;</button>
        </div>

        <table id="lowStockAlert">
          <thead>
            <tr>
              <th>Item</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody id="lowStockList"></tbody>
        </table>
      </div>

      <div class="form-sections" style="text-align: center;">
        <div class="form-box">
          <h3>Add Stock</h3>
          <select id="itemName"></select>
          <input type="number" id="itemQty" placeholder="Quantity" />
          <button onclick="addStock()" class="btn-stock">Add Stock</button>
        </div>
        <div class="form-box">
          <h3>Sales</h3>
          <select id="saleItem"></select>
          <input type="text" id="partyName" placeholder="Party Name" />
          <input type="number" id="saleQty" placeholder="Quantity Sold" />
          <button onclick="recordSale()" class="btn-sales">Sale</button>
        </div>
      </div>

      <div class="log-buttons">
        <button id="showStock" onclick="showLog('stock')" class="btn-stock">Added Stock</button>
        <button id="showSales" onclick="showLog('sales')" class="btn-sales">Sales</button>
        <button id="showBalance" onclick="showLog('balance')" class="btn-balance">Balance</button>
      </div>

      <div id="balanceFilters" class="filter-section" style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 20px;">
        <label for="materialDropdown">Filter by Material:</label>
        <select id="materialDropdown" onchange="onMaterialChange()">
          <option value="">-- All Materials --</option>
        </select>

        <label for="productDropdown">Filter by Product:</label>
        <select id="productDropdown" onchange="onProductChange()" disabled>
          <option value="">-- All Products --</option>
        </select>
      </div>

      <div class="log-section">
        <table id="stockTable" class="log-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Added By</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <table id="salesTable">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Party Name</th>
              <th>Quantity</th>
              <th>Sold By</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <table id="balanceTable" class="log-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Balance Quantity</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script>
      let registeredItems = [];
      let stockLog = [];
      let salesLog = [];

      function logout() {
        sessionStorage.clear();
        window.location.href = "login.html";
      }

      function addStock() {
        const item_id = document.getElementById("itemName").value;
        const qty = parseInt(document.getElementById("itemQty").value);
        const user_id = sessionStorage.getItem("user_id");

        if (!item_id || isNaN(qty) || !user_id) {
          alert("Enter valid item and quantity.");
          return;
        }

        fetch("https://bpi.infinityfreeapp.com/record_stock.php", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ item_id, quantity: qty, added_by: user_id })
        }).then(res => res.json())
          .then(data => {
            alert(data.message);
            if (data.success) {
              document.getElementById("itemQty").value = "";
              fetchAndRenderLogs();
            }
          });
      }

      function recordSale() {
        const item_id = document.getElementById("saleItem").value;
        const party_name = document.getElementById("partyName").value.trim();
        const qty = parseInt(document.getElementById("saleQty").value);
        const user_id = sessionStorage.getItem("user_id");

        if (!item_id || !party_name || isNaN(qty) || !user_id) {
          alert("Enter valid item, party name, and quantity.");
          return;
        }

        fetch("https://bpi.infinityfreeapp.com/record_sale.php", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ item_id, party_name, quantity: qty, sold_by: user_id })
        }).then(res => res.json())
          .then(data => {
            alert(data.message);
            if (data.success) {
              document.getElementById("saleQty").value = "";
              document.getElementById("partyName").value = "";
              fetchAndRenderLogs();
            }
          });
      }

      function fetchAndRenderLogs() {
        Promise.all([
          fetch("https://bpi.infinityfreeapp.com/get_items.php").then(res => res.json()),
          fetch("https://bpi.infinityfreeapp.com/get_stock_log.php").then(res => res.json()),
          fetch("https://bpi.infinityfreeapp.com/get_sales_log.php").then(res => res.json())
        ]).then(([items, stock, sales]) => {
          registeredItems = items;
          stockLog = stock;
          salesLog = sales;

          populateItemDropdowns();
          renderStock(stockLog);
          renderSales(salesLog);
          renderBalance(registeredItems, stockLog, salesLog);
          renderLowStockAlert();
        });
      }

      function populateItemDropdowns() {
        const itemName = document.getElementById("itemName");
        const saleItem = document.getElementById("saleItem");

        itemName.innerHTML = '<option value="">-- Select Item --</option>';
        saleItem.innerHTML = '<option value="">-- Select Item --</option>';

        registeredItems.forEach(item => {
          const label = `${item.name} - ${item.size} - ${item.material}`;
          const option = new Option(label, item.id);
          itemName.appendChild(option.cloneNode(true));
          saleItem.appendChild(option);
        });
      }

      function renderStock(log) {
        const tbody = document.querySelector("#stockTable tbody");
        tbody.innerHTML = "";
        log.forEach(entry => {
          const item = registeredItems.find(i => i.id == entry.item_id);
          const name = item ? `${item.name} - ${item.size} - ${item.material}` : 'Unknown';
          const addedBy = entry.added_by_username || entry.added_by || "Unknown";
          tbody.innerHTML += `<tr>
            <td>${name}</td>
            <td>${entry.quantity}</td>
            <td>${addedBy}</td>
            <td>${entry.timestamp}</td>
          </tr>`;
        });
      }

      function renderSales(log) {
        const tbody = document.querySelector("#salesTable tbody");
        tbody.innerHTML = "";
        log.forEach(entry => {
          const name = entry.item_name 
            ? `${entry.item_name} - ${entry.size} - ${entry.material}`
            : "Unknown";
          const party = entry.party_name ? entry.party_name : "N/A";
          const soldBy = entry.sold_by_username || entry.sold_by || "Unknown";
          const date = entry.timestamp;

          tbody.innerHTML += `
            <tr>
              <td>${name}</td>
              <td>${party}</td>
              <td>${entry.quantity}</td>
              <td>${soldBy}</td>
              <td>${date}</td>
            </tr>`;
        });
      }

      function renderBalance(items, stock, sales) {
        const balance = {};
        items.forEach(item => {
          balance[item.id] = {
            name: `${item.name} - ${item.size} - ${item.material}`,
            quantity: 0
          };
        });

        stock.forEach(entry => {
          if (balance[entry.item_id]) balance[entry.item_id].quantity += parseInt(entry.quantity);
        });

        sales.forEach(entry => {
          if (balance[entry.item_id]) balance[entry.item_id].quantity -= parseInt(entry.quantity);
        });

        const tbody = document.querySelector("#balanceTable tbody");
        tbody.innerHTML = "";
        Object.values(balance).forEach(entry => {
          tbody.innerHTML += `<tr><td>${entry.name}</td><td>${entry.quantity}</td></tr>`;
        });
      }

      function renderLowStockAlert() {
        const LOW_STOCK_THRESHOLD = 1500;
        const alertTable = document.getElementById("lowStockAlert");
        const alertList = document.getElementById("lowStockList");
        alertList.innerHTML = "";

        if (!registeredItems.length || !stockLog.length || !salesLog.length) {
          alertTable.style.display = "none";
          return;
        }

        const balance = {};
        registeredItems.forEach(item => balance[item.id] = 0);

        stockLog.forEach(entry => {
          const id = entry.item_id.toString();
          if (balance[id] !== undefined) balance[id] += parseInt(entry.quantity) || 0;
        });

        salesLog.forEach(entry => {
          const id = entry.item_id.toString();
          if (balance[id] !== undefined) balance[id] -= parseInt(entry.quantity) || 0;
        });

        const lowStockItems = registeredItems.filter(item => (balance[item.id] || 0) <= LOW_STOCK_THRESHOLD);

        if (!lowStockItems.length) {
          alertTable.style.display = "none";
          return;
        }

        lowStockItems.forEach(item => {
          const qty = balance[item.id];
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${item.name} - ${item.size} - ${item.material}</td><td>${qty}</td>`;
          alertList.appendChild(tr);
        });

        alertTable.style.display = "table";
      }

      function showLog(type) {
        document.querySelectorAll('.log-buttons button').forEach(btn => btn.classList.remove('active'));

        if (type === "stock") {
          document.getElementById("showStock").classList.add('active');
        } else if (type === "sales") {
          document.getElementById("showSales").classList.add('active');
        } else if (type === "balance") {
          document.getElementById("showBalance").classList.add('active');
        }

        document.getElementById("stockTable").style.display = "none";
        document.getElementById("salesTable").style.display = "none";
        document.getElementById("balanceTable").style.display = "none";
        document.getElementById("balanceFilters").style.display = "none";

        if (type === "stock") {
          document.getElementById("stockTable").style.display = "table";
        } else if (type === "sales") {
          document.getElementById("salesTable").style.display = "table";
        } else if (type === "balance") {
          document.getElementById("balanceTable").style.display = "table";
          document.getElementById("balanceFilters").style.display = "flex";
          populateMaterialDropdown();
          renderBalance(registeredItems, stockLog, salesLog);
        }
      }

      function populateMaterialDropdown() {
        const dropdown = document.getElementById("materialDropdown");
        dropdown.innerHTML = '<option value="">-- All Materials --</option>';
        const materials = [...new Set(registeredItems.map(i => i.material))];
        materials.forEach(material => {
          const opt = new Option(material, material);
          dropdown.appendChild(opt);
        });

        const productDropdown = document.getElementById("productDropdown");
        productDropdown.innerHTML = '<option value="">-- All Products --</option>';
        productDropdown.disabled = true;
      }

      function onMaterialChange() {
        const material = document.getElementById("materialDropdown").value;
        const productDropdown = document.getElementById("productDropdown");

        if (!material) {
          productDropdown.innerHTML = '<option value="">-- All Products --</option>';
          productDropdown.disabled = true;
          renderBalance(registeredItems, stockLog, salesLog);
          return;
        }

        const filteredItems = registeredItems.filter(i => i.material === material);
        renderBalance(filteredItems, stockLog, salesLog);

        const products = [...new Set(filteredItems.map(i => i.name))];
        productDropdown.innerHTML = '<option value="">-- All Products --</option>';
        products.forEach(p => {
          const opt = new Option(p, p);
          productDropdown.appendChild(opt);
        });
        productDropdown.disabled = false;
      }

      function onProductChange() {
        const material = document.getElementById("materialDropdown").value;
        const product = document.getElementById("productDropdown").value;

        let filtered = registeredItems;

        if (material) filtered = filtered.filter(i => i.material === material);
        if (product) filtered = filtered.filter(i => i.name === product);

        renderBalance(filtered, stockLog, salesLog);
      }

      // Low Stock Alert close button
      const lowStockContainer = document.getElementById('lowStockContainer');
      const closeLowStockBtn = document.getElementById('closeLowStock');

      closeLowStockBtn.addEventListener('click', () => {
        lowStockContainer.style.display = 'none';
      });
      
      fetchAndRenderLogs();
      showLog('stock');
    </script>
  </body>
</html>
